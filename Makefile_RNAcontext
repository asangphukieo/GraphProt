SHELL:=/bin/bash
.DELETE_ON_ERROR:

# don't delete intermediate files
.SECONDARY:

# paths
ROOT:=~/projects/RBPaffinity
FA_DIR:=~$(ROOT)/data/fasta
THR_DIR:=$(ROOT)/data/thresholds/

# progs
RNACONTEXT=~/src/RNAcontext/bin/rnacontext
PERF:=~/src/stat/perf
FASTAPL:=/usr/local/user/RNAtools/fastapl

# proteins to use
PROTEINS:=Fusip HuR PTB RBM4 SF2 SLM2 U1A VTS1 YB1
#PROTEINS:=test

# targets
FULL_BASENAMES:=$(patsubst %,%_data_full_A,$(PROTEINS)) \
			$(patsubst %,%_data_full_B,$(PROTEINS))
BRUIJN_BASENAMES:=$(patsubst %,%_data_bruijn_A,$(PROTEINS)) \
			$(patsubst %,%_data_bruijn_B,$(PROTEINS))
BASENAMES:=$(FULL_BASENAMES) $(BRUIJN_BASENAMES)

PROFILES:=$(patsubst %, %.profile, $(BASENAMES))
SEQUENCES:=$(patsubst %, %.sequence, $(BASENAMES))
RESULTDIRS:=$(patsubst %, %.dummy, $(BASENAMES))

RNACONTEXT_OUTPUTS:=$(wildcard outputs/train*.txt) $(wildcard outputs/test*.txt)
PERF_FILES:=$(RNACONTEXT_OUTPUTS:.txt=.perf)

.PHONY: all
all: $(RESULTDIRS)

.PHONY: perf
perf: results_aucpr.csv

%.sequence : %.fa
	cat $< | /usr/local/perl/bin/perl $(FASTAPL) -e 'my @vals = split(/\s/, $$head); my $$affy=pop @vals ;print $$affy, "\t", $$seq, "\n";' > $@

%.profile : %.fa
	-rm -fv %@
	mkdir $@.tmp /var/tmp/$@.tmp
	cd $@.tmp; ln -s ../sfold-2.1/* ./;	ln -s /var/tmp/$@.tmp out; ./sfold_helper ../$< ../$@
	-rm -rfv $@.tmp /var/tmp/$@.tmp

%.dummy : %.sequence %.profile %.pred.sequence %.pred.profile
	mkdir -p outputs
	$(RNACONTEXT) -s 3 -w 4-12 -a ACGT -e PHIME -c $*.sequence -h $*.profile -d $*.pred.sequence -n $*.pred.profile -o $* && touch $@

%.perf : BASENAME=$(word 2,$(subst _, ,$<))
%.perf : $(shell echo $(BASENAME))
%.perf : HT=$(shell grep $(BASENAME) $(THR_DIR)/positive.txt | cut -f 2 -d' ')
%.perf : LT=$(shell grep $(BASENAME) $(THR_DIR)/negative.txt | cut -f 2 -d' ')
%.perf : %.txt
	# select by threshold
	( cat $< | awk '$$1 > $(HT)' | cut -f 2 | awk '{print 1 "\t" $$1 }'; \
	cat $< | awk '$$1 < $(LT)' | cut -f 2 | awk '{print 0 "\t" $$1}' ) > $@.threshold
	# compute performance measures
	$(PERF) < $@.threshold > $@
	rm -rf $@.threshold*

results_aucpr.csv : $(PERF_FILES)
	grep ROC $(PERF_FILES) | tr ':' ' ' | \
	awk '{print $$1, "$(EXPERIMENT_ID)", $$NF}' | sort > roc.tmp
	grep APR $(PERF_FILES) | tr ':' ' ' | \
	awk '{print $$1, "$(EXPERIMENT_ID)", $$NF}' | cut -f 1,3 -d' ' | \
	sort > aucpr.tmp
	join roc.tmp aucpr.tmp > $@
	rm -rf roc.tmp aucpr.tmp
