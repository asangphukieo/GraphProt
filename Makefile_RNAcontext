# secondary structure profiles can be computed using
# PLFOLD or SFOLD
PROFILE_COMP:=SFOLD

SHELL:=/bin/bash
.DELETE_ON_ERROR:

# don't delete intermediate files
.SECONDARY:

# paths
ROOT:=~/projects/RBPaffinity
FA_DIR:=~$(ROOT)/data/fasta
THR_DIR:=$(ROOT)/data/thresholds/

# progs
RNACONTEXT=~/src/RNAcontext/bin/rnacontext
PERF:=~/src/stat/perf
FASTAPL:=/usr/local/user/RNAtools/fastapl
# this includes the modifications from RNAcontext for computing structure accs
SFOLD_DIR:=/home/maticzkd/src/sfold-2.2

# proteins to use
PROTEINS:=Fusip HuR PTB RBM4 SF2 SLM2 U1A VTS1 YB1
#PROTEINS:=test

# targets
FULL_BASENAMES:=$(patsubst %,%_data_full_A,$(PROTEINS)) \
			$(patsubst %,%_data_full_B,$(PROTEINS))
BRUIJN_BASENAMES:=$(patsubst %,%_data_bruijn_A,$(PROTEINS)) \
			$(patsubst %,%_data_bruijn_B,$(PROTEINS))
BASENAMES:=$(FULL_BASENAMES) $(BRUIJN_BASENAMES)

PROFILES:=$(patsubst %, %.profile, $(BASENAMES)) $(patsubst %, %.pred.profile, $(BASENAMES))
SEQUENCES:=$(patsubst %, %.sequence, $(BASENAMES))
RESULTDIRS:=$(patsubst %, %.dummy, $(BASENAMES))

RNACONTEXT_OUTPUTS:=$(wildcard outputs/train*.txt) $(wildcard outputs/test*.txt)
PERF_FILES:=$(RNACONTEXT_OUTPUTS:.txt=.perf)

.PHONY: all
all: $(RESULTDIRS)

.PHONY: profile
profile: $(PROFILES)

.PHONY: perf
perf: results.csv best.csv.dummy

%.sequence : %.fa
	cat $< | /usr/local/perl/bin/perl $(FASTAPL) -e 'my @vals = split(/\s/, $$head); my $$affy=pop @vals ;print $$affy, "\t", $$seq, "\n";' > $@

ifeq ($(PROFILE_COMP),SFOLD)

%.profile : %.fa
	-rm -rfv $@ $@.tmp /var/tmp/$@.tmp_data /var/tmp/$@.tmp_out
	mkdir $@.tmp /var/tmp/$@.tmp_data /var/tmp/$@.tmp_out
	cd $@.tmp; ln -s $(SFOLD_DIR)/* ./;	ln -s /var/tmp/$@.tmp_data data; ln -s /var/tmp/$@.tmp_out out; ./sfold_helper ../$< ../$@
	-rm -rfv $@.tmp /var/tmp/$@.tmp

%.dummy : %.sequence %.profile %.pred.sequence %.pred.profile
	mkdir -p outputs
	$(RNACONTEXT) -s 3 -w 4-12 -a ACGT -e PLMU -c $*.sequence -h $*.profile -d $*.pred.sequence -n $*.pred.profile -o $* && touch $@

else
ifeq ($(PROFILE_COMP),PLFOLD)

%.profile : %.fa
	cat $< | ./RNAplfold_context_stdout -W 50 -L 50 -u 1 | perl ./pl2context.pl > $@

%.dummy : %.sequence %.profile %.pred.sequence %.pred.profile
	$(RNACONTEXT) -s 3 -w 4-12 -a ACGT -e PHIME -c $*.sequence -h $*.profile -d $*.pred.sequence -n $*.pred.profile -o $* && touch $@

endif
endif

%.perf : BASENAME=$(word 2,$(subst _, ,$<))
%.perf : $(shell echo $(BASENAME))
%.perf : HT=$(shell grep $(BASENAME) $(THR_DIR)/positive.txt | cut -f 2 -d' ')
%.perf : LT=$(shell grep $(BASENAME) $(THR_DIR)/negative.txt | cut -f 2 -d' ')
%.perf : %.txt
	# select by threshold
	( cat $< | awk '$$1 > $(HT)' | cut -f 2 | awk '{print 1 "\t" $$1 }'; \
	cat $< | awk '$$1 < $(LT)' | cut -f 2 | awk '{print 0 "\t" $$1}' ) > $@.threshold
	# compute performance measures
	$(PERF) < $@.threshold > $@
	rm -rf $@.threshold*

results.csv : $(PERF_FILES)
	grep APR $^ | tr '/_' '  ' | sed 's/bruijn/weak/g' | sed 's/.perf:APR//g' | tr "\t" ' ' | awk '{print $$2,$$3,$$5,$$6,$$7,$$NF}' > results.csv

best.csv.dummy : results.csv
	R --slave < RNAcontext_Auswertung.R && touch $@

