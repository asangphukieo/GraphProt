.DELETE_ON_ERROR:

# don't delete intermediate files
#.SECONDARY:

# parameters:
EXPERIMENT_ID:=svr_acccontextDir
LINESEARCH_INPUT_SIZE:=5000
CV_FOLD:=5

# paths
ROOT:=~/projects/RBPaffinity
FA_DIR:=~/projects/RBPaffinity/data/fasta
THR_DIR:=~/projects/RBPaffinity/data/thresholds/

# binaries
SVRTRAIN:=~/src/libsvm-3.0/svm-train -s 3 -t 0 -m 2000
SVRPREDICT:=~/src/libsvm-3.0/svm-predict
PERF:=~/src/stat/perf
LINESEARCH:=$(ROOT)/bin/lineSearch.pl
COMBINEFEATURES:=$(ROOT)/bin/combineFeatures.pl
SHUF:=~/src/coreutils-8.15/src/shuf
FASTAPL:=/usr/local/user/RNAtools/fastapl
FASTA2GSPAN:=/usr/local/user/RNAtools/fasta2shrep_gspan.pl

# important files
# parameters for line search (including defaults):
LSPAR:=$(ROOT)/bin/ls.parameters
DEFPAR:=$(ROOT)/bin/default.parameters

# targets
#PROTEINS:=Fusip HuR PTB RBM4 SF2 SLM2 U1A VTS1 YB1
PROTEINS:=test
BASENAMES:=$(patsubst %,%_data_full_A,$(PROTEINS))
#			$(patsubst %,%_data_full_B,$(PROTEINS))
#			$(patsubst %,%_data_bruijn_A,$(PROTEINS)) \
#			$(patsubst %,%_data_bruijn_B,$(PROTEINS))
PERF_FILES:=$(patsubst %,%.perf,$(BASENAMES))
PARAM_FILES:=$(patsubst %,%.param,$(BASENAMES))
CV_FILES:=$(patsubst %,%.cv,$(BASENAMES))

all: $(PERF_FILES) results_aucpr.csv

ls : $(PARAM_FILES)

cv : $(CV_FILES)

%.cv : C=$(shell grep '^c ' $*.param | cut -f 2 -d' ')
%.cv : EPSILON=$(shell grep '^e ' $*.param | cut -f 2 -d' ')
%.cv : %.feature %.param
	$(SVRTRAIN) -c $(C) -p $(EPSILON) -h 0 -v $(CV_FOLD) $< > $@

# if not available, copy fasta from data dir
%.fa : $(FA_DIR)/%.fa
	cp $< $@

# if available, create gspan from precomputed files
%.gspan : %.gspan.gz
	zcat $< > $@

# else, create gspan from fasta
%.gspan : ABSTRACTION=$(shell grep '^ABSTRACTION ' $*.param | cut -f 2 -d' ')
%.gspan : STACK=$(subst nil,,$(shell grep '^STACK ' $*.param | cut -f 2 -d' '))
%.gspan : CUE=$(subst nil,,$(shell grep '^CUE ' $*.param | cut -f 2 -d' '))
%.gspan : %.fa %.param
	time $(FASTA2GSPAN) $(STACK) $(CUE) -stdout -q -Tp 0.05 -t $(ABSTRACTION) -M 5 -fasta $< > $@

# link parameter file for simpler handling
%.pred.param : %.param
	ln -sf $< $@

## just link default parameters; for using optimized parameters just supply
## alternative parameter files
#%.param :
#	ln -sf $(DEFPAR) $@

# do parameter optimization by line search
%.param : %.ls.fa $(LSPAR)
	$(LINESEARCH) -d -fa $< -param $(LSPAR) -mf Makefile -of $@

# subset original fasta
%.ls.fa : %.fa
	cat $< | \
	$(FASTAPL) -e 'print ">", $$head, "\t", $$seq, "\n"' | $(SHUF) -n $(LINESEARCH_INPUT_SIZE) | \
	perl -ane '$$seq = pop @F; $$head = join(" ", @F); print $$head, "\n", $$seq, "\n";' > \
	$@

# feature creation for this type of graph has to set an additional parameter
# in order to center only on nucleotides and not on annotation -> -T nspdkvp
%.feature : RADIUS=$(shell grep '^R ' $*.param | cut -f 2 -d' ')
%.feature : DISTANCE=$(shell grep '^D ' $*.param | cut -f 2 -d' ')
%.feature : bitsize=$(shell grep '^b ' $*.param | cut -f 2 -d' ')
%.feature : DIRECTED=$(shell grep '^DIRECTED ' $*.param | cut -f 2 -d' ')
%.feature : %.gspan %.affy %.param
	# create features
	# remove t and w, convert s to t
	cat $< | grep -v -e '^t' -e '^w' | sed 's/^s/t/' > $*_singleshreps
	$(ROOT)/bin/NSPDK -fg $*_singleshreps -of -R $(RADIUS) -D $(DISTANCE) -b $(bitsize) -gt $(DIRECTED)
	-rm -f $*_singleshreps $*_singleshreps.feature_bin # clean up after feature creation
	# write out probabilities
	cat $< | grep '^s' | perl -ne '($$prob) = /SHAPEPROB ([0-9.]+)/; print $$prob, "\n"' > $*_probs
	# write out shrep membership
	cat $< | awk '/^t/{i++}/^s/{print i}' > $*_groups
	# go go perl
	/usr/local/perl/bin/perl $(COMBINEFEATURES) $*_singleshreps.feature $*_probs $*_groups > $*
	-rm -f $*_singleshreps.feature $*_probs $*_groups
	# add affinities to features
	cat $* | grep -v \"^\$\" | paste -d' ' $*.affy - > $@

%.affy : %.gspan
	# extract affinities from gspan
	cat $< | grep '^t' | awk '{print $$5}' > $@

%.model : C=$(shell grep '^c' $*.param | cut -f 2 -d' ')
%.model : EPSILON=$(shell grep '^e' $*.param | cut -f 2 -d' ')
%.model : %.feature %.param
	$(SVRTRAIN) -c $(C) -p $(EPSILON) $< $@

%.svrout : %.model %.pred.feature
	$(SVRPREDICT) $*.pred.feature $< $@

%.pred : %.svrout %.pred.affy
	# combine affinities and predictions
	paste $*.pred.affy $< > $@

%.perf : BASENAME=$(firstword $(subst _, ,$<))
%.perf : $(shell echo $(BASENAME))
%.perf : HT=$(shell grep $(BASENAME) $(THR_DIR)/positive.txt | cut -f 2 -d' ')
%.perf : LT=$(shell grep $(BASENAME) $(THR_DIR)/negative.txt | cut -f 2 -d' ')
%.perf : %.pred
	# select by threshold
	( cat $< | awk '$$1 > $(HT)' | cut -f 2 | awk '{print 1 "\t" $$1 }'; \
	cat $< | awk '$$1 < $(LT)' | cut -f 2 | awk '{print 0 "\t" $$1}' ) > $@.threshold
	# compute performance measures
	$(PERF) < $@.threshold > $@
	rm -rf $@.threshold*

results_aucpr.csv : $(PERF_FILES)
	grep ROC $(PERF_FILES) | tr ':' ' ' | \
	awk '{print $$1, "$(EXPERIMENT_ID)", $$NF}' | sort > roc.tmp
	grep APR $(PERF_FILES) | tr ':' ' ' | \
	awk '{print $$1, "$(EXPERIMENT_ID)", $$NF}' | cut -f 1,3 -d' ' | \
	sort > aucpr.tmp
	join roc.tmp aucpr.tmp > $@
	rm -rf roc.tmp aucpr.tmp

# keep predictions and results
clean:
	-rm -rf $(MODELS) log *.gspan *.threshold* *.model *.feature *.affy *.svrout
